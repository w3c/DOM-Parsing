<!doctype html>
<html>
<head>
    <meta charset=UTF-8>
    <title>DOM Parsing and Serialization</title>
    <style>
        /* Make these stand-out more... */
        .externalDFN {
            font-style: italic;
            background-color: #fff9d6;
        }
        /* Switch statement */
        dl.switch dt::before {
            content: "↪ ";
            margin-left: 1em;
        }
        /* Better spacing around various lists (implied paragraph children) */
        ol > li, section:not(#toc) ul > li, section dl > dt {
            margin: 1em 0;
        }
        /* domintro styling */
        dl.domintro {
            background-color: rgb(221, 255, 221);
            padding: 1em 0.5em 1em 2em;
            clear: both;
        }
        dl.domintro dt {
            color: black;
        }
        dl.domintro > dd {
            color: green;
        }
        dl.domintro::before {
            float: right;
            background-color: white;
            display: block;
            border: 2px solid black;
            color: green;
            margin-top: -20px;
            padding: 2px;
            content: "This box is non-normative. Implementation requirements are given below this box.";
        }
        /* Fancy table stuff */
        table {
            border-collapse: collapse;
        }
        thead tr {
            border-bottom: 2px solid black;
        }
        tbody tr:not(:last-child) {
            border-bottom: 1px solid black;
        }
        td {
            border-left: 1px solid black;
            padding: 4px;
        }
        /* Extra IDL :-) */
        .extraidl {
            line-height: 120%;
            padding: 1em;
            border-top: 1px solid #90b8de;
            border-bottom: 1px solid #90b8de;
        }
        .extraidl:before {
            width: 150px;
            color: #fff;
            padding: 3px;
            font-weight: bold;
            font-family: initial;
            margin: -1em 0 1em -1em;
            display: block;
            content: "WebIDL";
            background-color: rgb(144, 184, 222);
        }
    </style>
    <script type="text/javascript" src='https://www.w3.org/Tools/respec/respec-w3c-common' class='remove' async></script>
    <script type="text/javascript" src="respecConfig.js" class='remove'></script>
</head>
<body>

    <section id="abstract">
       <p>This specification defines various APIs for programmatic access to 
          HTML and generic XML parsers by web applications for use in parsing 
          and serializing DOM nodes</p>
    </section>

    <section id="sotd"></section>


    <section id="issues" class="introductory">
        <h1>Issues</h1>
        
        <p class=issue>Open issues that appear throughout the remainder of this 
        document will be highlighted like this.</p>
        
        <!-- I don't believe this is a point of contention anymore...
        <p class="issue">This specification currently requires using the XML 
        Parser for some APIs, when in an XML document. It is unclear whether 
        consensus can be found for this approach.</p>
        -->
    </section>

    <section id="conformance">
        <p>Requirements phrased in the imperative as part of algorithms
        (such as "strip any leading space characters" or "return false and
        terminate these steps") are to be interpreted with the meaning of the
        key word ("must", "should", "may", etc) used in introducing the
        algorithm.</p>

        <p>Conformance requirements phrased as algorithms or specific steps
        may be implemented in any manner, so long as the end result is
        equivalent. (In particular, the algorithms defined in this
        specification are intended to be easy to follow, and not intended to
        be performant.)</p>

        <p id="hardwareLimitations">User agents may impose
        implementation-specific limits on otherwise unconstrained inputs,
        e.g. to prevent denial of service attacks, to guard against running
        out of memory, or to work around platform-specific limitations.</p>

        <p>When a method or an attribute is said to call another method or 
        attribute, the user agent must invoke its internal API for that 
        attribute or method so that e.g. the author can't change the behavior 
        by overriding attributes or methods with custom properties or functions 
        in ECMAScript.</p>

        <p>Unless otherwise stated, string comparisons are done in a <a
        data-spec="DOM4" class="externalDFN" title="case-sensitive">
        case-sensitive</a> manner.</p>

        <p>If an algorithm calls into another algorithm, any exception that is 
        thrown by the latter (unless it is explicitly caught), must cause the 
        former to terminate, and the exception to be propagated up to 
        <em>its</em> caller.</p>
    
        <section>
            <h2>Dependencies</h2>

            <p>The IDL fragments in this specification must be interpreted as
            required for conforming IDL fragments, as described in the Web IDL
            specification. [[!WEBIDL]]</p>

            <p>Some of the terms used in this specification are defined in
            [[DOM4]], [[HTML5]], and [[XML10]].
        </section>

        <section>
            <h2>Extensibility</h2>

            <p>Vendor-specific proprietary extensions to this specification are
            strongly discouraged. Authors must not use such extensions, as
            doing so reduces interoperability and fragments the user base,
            allowing only users of specific user agents to access the content in
            question.</p>

            <p>If vendor-specific extensions are needed, the members should be
            prefixed by vendor-specific strings to prevent clashes with future
            versions of this specification. Extensions must be defined so that
            the use of extensions neither contradicts nor causes the
            non-conformance of functionality defined in the specification.</p>

            <p>When vendor-neutral extensions to this specification are needed,
            either this specification can be updated accordingly, or an
            extension specification can be written that overrides the
            requirements in this specification. When someone applying this
            specification to their activities decides that they will recognise
            the requirements of such an extension specification, it becomes an
            <dfn title="other applicable specifications">applicable
            specification</dfn> for the purposes of conformance requirements in
            this specification.</p>
            <!-- http://www.w3.org/mid/17E341CD-E790-422C-9F9A-69347EE01CEB@iki.fi -->
        </section>
    </section>

    <section>
        <h2>Terminology</h2>

        <p>The term <dfn>context object</dfn> means the object on which the method or
        attribute being discussed was called.
    </section>


    <section>
        <h1>Parsing and serializing <a title="node" data-spec="DOM4" class="externalDFN">Node</a>s</h1>

        <section>
            <h2>Parsing</h2>

            <p>The following steps form the
            <dfn title="concept-parse-fragment">fragment parsing algorithm</dfn>, whose
            arguments are a <var>markup</var> string and a
            <var>context element</var>.

            <ol>
              <li>
                <p>If the <var>context element</var>'s
                <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
                is an <a title="html-document" data-spec="DOM4" class="externalDFN">HTML document</a>: let
                <var>algorithm</var> be the
                <a title="html-fragment-parsing-algorithm" data-spec="HTML5" class="externalDFN">HTML 
                fragment parsing algorithm</a>.</p>

                <p>If the <var>context element</var>'s
                <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
                is an <a title="xml-document" data-spec="DOM4" class="externalDFN">XML document</a>: let
                <var>algorithm</var> be the
                <a title="xml-fragment-parsing-algorithm" data-spec="HTML5" class="externalDFN">XML 
                fragment parsing algorithm</a>.</p>
              </li>

              <li>Invoke <var>algorithm</var> with <var>markup</var> as
              the <var>input</var>, and <var>context element</var> as the
              <var><a data-spec="HTML5" title="concept-frag-parse-context" class="externalDFN">context</a></var>
              element.</li>

              <li>Let <var>new children</var> be the nodes returned.</li>

              <li>Let <var>fragment</var> be a new
              <code><a title="documentfragment" data-spec="DOM4" class="externalDFN">DocumentFragment</a></code> whose
              <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
              is <var>context element</var>'s
              <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>.

              <li><a data-spec="DOM4" title="concept-node-append" class="externalDFN">Append</a>
              each <a data-spec="DOM4" title="concept-node" class="externalDFN">node</a> in
              <var>new children</var> to <var>fragment</var> (in order).

              <p class=note>This ensures the
              <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
              for the new <a data-spec="DOM4" title=concept-node class="externalDFN">nodes</a> is correct.

              <li>Return <var>fragment</var>.
            </ol>
    </section>

    <section>
        <h2>Serializing</h2>
        <p>To <dfn title=concept-serialize>serialize</dfn> a
        <a title="node" data-spec="DOM4" class="externalDFN">Node</a> <var>node</var>, the user agent
        must run the following steps:

        <ol>
          <li>Let <var>document</var> be <var>node</var>'s
          <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>.

          <li>If <var>document</var> is an
          <a title="html-document" data-spec="DOM4" class="externalDFN">HTML document</a>, return an
          <a title=concept-serialize-html>HTML serialization</a> of
          <var>node</var>.

          <li>Otherwise, <var>document</var> is an
          <a title="xml-document" data-spec="DOM4" class="externalDFN">XML document</a>. Return an
          <a title=concept-serialize-xml>XML serialization</a> of
          <var>node</var>.
        </ol>

        <p>To <dfn title=concept-serialize-html>produce an HTML serialization</dfn> of a
        <a title="node" data-spec="DOM4" class="externalDFN">Node</a> <var>node</var>, the user agent
        must run the appropriate steps, depending on <var>node</var>'s interface:

        <dl class=switch>
          <dt><code><a title="element" data-spec="DOM4" class="externalDFN">Element</a></code>
          <dt><code><a title="document" data-spec="DOM4" class="externalDFN">Document</a></code>
          <dt><code><a title="documentfragment" data-spec="DOM4" class="externalDFN">DocumentFragment</a></code>
          <dd><p>Run the
          <a data-spec="HTML5" title="html-fragment-serialization-algorithm" class="externalDFN">HTML fragment serialization algorithm</a> on
          <var>node</var>. Return the returned string.

          <dt><code><a title="comment" data-spec="DOM4" class="externalDFN">Comment</a></code>
          <dt><code><a title="text" data-spec="DOM4" class="externalDFN">Text</a></code>
          <dt><code><a title="documenttype" data-spec="DOM4" class="externalDFN">DocumentType</a></code>
          <dt><code><a title="processinginstruction" data-spec="DOM4" class="externalDFN">ProcessingInstruction</a></code>
          <dd class="issue">Define how these are serialized...</dd>
        </dl>

        <p>To <dfn title=concept-serialize-xml>produce an XML serialization</dfn> of a
        <a title="node" data-spec="DOM4" class="externalDFN">Node</a> <var>node</var>, the user agent
        must run the appropriate steps, depending on <var>node</var>'s interface:</p>

        <dl class=switch>
            <dt><code><a title="element" data-spec="DOM4" class="externalDFN">Element</a></code>
            <dd>
                <p>Return the concatenation of the following strings:
                <ol>
                  <li>"<code>&lt;</code>" (U+003C LESS-THAN SIGN);
                  <li>the value of <var>node</var>'s
                  <code><a title="dom-Element-tagName" data-spec="DOM4" class="externalDFN">tagName</a></code>
                  attribute;
                  <p class="issue">escaping / throwing
                  <li>the <a title=concept-serialize-xml-attributes>XML serialization of
                  <var>node</var>'s attributes</a>;
                  <li>"<code>&gt;</code>" (U+003E GREATER-THAN SIGN);
                  <li>the <a title=concept-serialize-xml>serialization</a> of
                  <var>node</var>'s
                  <a title="concept-tree-child" data-spec="DOM4" class="externalDFN">children</a>, in
                  order;
                  <li>"<code>&lt;/</code>" (U+003C LESS-THAN SIGN, U+002F SOLIDUS);
                  <li>the value of <var>node</var>'s
                  <code><a title="dom-Element-tagName" data-spec="DOM4" class="externalDFN">tagName</a></code>
                  attribute;
                  <li>"<code>&gt;</code>" (U+003E GREATER-THAN SIGN).
                </ol>

            <dt><code><a title="document" data-spec="DOM4" class="externalDFN">Document</a></code>
            <dd>
                <p>Run the
                <a data-spec="HTML5" title="xml-fragment-serialization-algorithm" class="externalDFN">XML fragment serialization algorithm</a> on
                <var>node</var>. Return the string this produced.

            <dt><code><a title="comment" data-spec="DOM4" class="externalDFN">Comment</a></code>
            <dd>
                <p>Let <var>markup</var> be the concatenation of "<code>&lt;!--</code>", <var>node</var>'s
                <code><a title="dom-characterdata-data" data-spec="DOM4" class="externalDFN">data</a></code>, and
                "<code>--></code>".

                <p>If <var>markup</var> matches the
                <code><a data-spec="XML10" title="comment" class="externalDFN">Comment</a></code> production, return
                <var>markup</var>. Otherwise, throw a
                <code><a title=domexception data-spec="DOM4" class="externalDFN">DOMException</a></code>
                with name <code>InvalidStateError</code>.

            <dt><code><a title="cdata" data-spec="DOML2" class="externalDFN">CDATASection</a></code>
            <dd>
                <p>Let <var>markup</var> be the concatenation of "<code>&lt;![CDATA[</code>", 
                <var>node</var>'s
                <code><a title="dom-characterdata-data" data-spec="DOM4" class="externalDFN">data</a></code>, 
                and "<code>]]></code>".

                <!-- This does not actually appear to be the case in implementations today.
                <p>If <var>data</var> doesn't match the
                  <code><a title="NT-CData" data-spec="XML10" class="externalDFN">CData</a></code> production, throw a
                  <code><a title=domexception data-spec="DOM4" class="externalDFN">DOMException</a></code>
                  with name <code>InvalidStateError</code> and terminate the entire algorithm.
                -->
                
                <p>Return <var>markup</var>.
                
                <p class=note>CDATASection objects may be created by the historical 
                <code>document.createCDATASection</code> API, or as a result of parsing an
                <a title="xml-document" data-spec="DOM4" class="externalDFN">XML document</a>.
                

            <dt><code><a title="text" data-spec="DOM4" class="externalDFN">Text</a></code>
            <dd>
                <p>Let <var>data</var> be <var>node</var>'s
                <code><a title="dom-characterdata-data" data-spec="DOM4" class="externalDFN">data</a></code>.

                <p>Return <var>data</var>.
                
            <dt><code><a title="documentfragment" data-spec="DOM4" class="externalDFN">DocumentFragment</a></code>
            <dd>
                <p>Let <var>markup</var> the empty string.

                <p>For each
                <a title=concept-tree-child data-spec="DOM4" class="externalDFN">child</a> of
                <var>node</var>, in order,
                <a title=concept-serialize-xml>produce an XML serialization</a>
                of the child and concatenate the result to <var>markup</var>.

                <p>Return <var>markup</var>.

            <dt><code><a title="documenttype" data-spec="DOM4" class="externalDFN">DocumentType</a></code>
            <dt><code><a title="processinginstruction" data-spec="DOM4" class="externalDFN">ProcessingInstruction</a></code>
            <dd class="issue">TODO</dd>
        </dl>

        <p>The <dfn title=concept-serialize-xml-attributes>XML serialization of the attributes</dfn> of an
        <a title=concept-element data-spec="DOM4" class="externalDFN">element</a>
        <var>element</var> is the result of the following algorithm:

        <ol>
          <li>Let <var>result</var> be the empty string.
          <li>For each
            <a title=concept-attribute data-spec="DOM4" class="externalDFN">attribute</a>
            <var>attr</var> in <var>element</var>
            <a title=concept-element-attribute data-spec="DOM4" class="externalDFN">attributes</a>,
            in order, append the following strings to <var>result</var>:
            <ol>
              <li>"<code> </code>" (U+0020 SPACE);
              <li><var>attr</var>'s
              <a title=concept-attribute-name data-spec="DOM4" class="externalDFN">name</a>;
              <p class="issue">escaping / throwing
              <li>"<code>="</code>" (U+003D EQUALS SIGN, U+0022 QUOTATION MARK);
              <li><var>attr</var>'s
              <a title=concept-attribute-value data-spec="DOM4" class="externalDFN">value</a>;
              <p class="issue">escaping / throwing
              <li>"<code>"</code>" (U+0022 QUOTATION MARK).
            </ol>
          <li>Return <var>result</var>.
        </ol>
    </section>
</section>

<section>
    <h1>The <code>DOMParser</code> interface</h1>
    
<pre class=extraidl>enum <span class=idlInterfaceID>SupportedType</span> {
    "text/html",
    "text/xml",
    "application/xml",
    "application/xhtml+xml",
    "image/svg+xml"
};</pre>

    <p>The <dfn title=dom-DOMParser><code>DOMParser()</code></dfn> constructor
    must return a new <code>DOMParser</code> object.

    <dl class="idl" title="[Constructor] interface DOMParser">
        <dt>Document parseFromString(DOMString str, SupportedType type)</dt>
        <dd>
            <p>The
            <dfn title=dom-DOMParser-parseFromString><code>parseFromString(<var>str</var>, <var>type</var>)</code></dfn>
            method must run these steps, depending on <var>type</var>:

            <dl class=switch>
                <dt>"<code>text/html</code>"
                <dd>
                <p>Parse <var>str</var> with an
                <code><a data-spec="HTML5" title="html-parser" class="externalDFN">HTML parser</a></code>, and return the newly
                created <a title=concept-document data-spec="DOM4" class="externalDFN">document</a>.

                <p>The <a data-spec="HTML5" title="scripting-flag" class="externalDFN">scripting flag</a> must be set to
                "disabled".

                <p class=note><code><a data-spec="HTML5" title="meta" class="externalDFN">meta</a></code> elements are not
                taken into account for the encoding used, as a Unicode stream is passed into
                the parser.

                <p class=note><code><a data-spec="HTML5" title="script" class="externalDFN">script</a></code> elements get marked
                unexecutable and the contents of <code><a data-spec="HTML5" title="noscript" class="externalDFN">noscript</a></code>
                get parsed as markup.

                <dt>"<code>text/xml</code>"
                <dt>"<code>application/xml</code>"
                <dt>"<code>application/xhtml+xml</code>"
                <dt>"<code>image/svg+xml</code>"
                <dd>
                <ol>
                    <li>Parse <var>str</var> with a namespace-enabled
                    <code><a data-spec="HTML5" title="xml-parser" class="externalDFN">XML parser</a></code>.

                    <li>If the previous step didn't return an error, return the newly
                    created <a title=concept-document data-spec="DOM4" class="externalDFN">document</a>
                    and terminate these steps.

                    <li>Let <var>document</var> be a newly-created
                    <code><a data-spec="DOM4" title="xmldocument" class="externalDFN">XMLDocument</a></code>.

                    <li>
                    <p>Let <var>root</var> be a new
                    <code><a title="element" data-spec="DOM4" class="externalDFN">Element</a></code>, with its
                    <a title=concept-element-local-name data-spec="DOM4" class="externalDFN">local name</a>
                    set to "<code>parsererror</code>" and its
                    <a title=concept-element-namespace data-spec="DOM4" class="externalDFN">namespace</a>
                    set to
                    "<code>http://www.mozilla.org/newlayout/xml/parsererror.xml</code>".
                    <!-- see https://bugzilla.mozilla.org/show_bug.cgi?id=45566 -->
                    <p>At this point user agents may
                    <a data-spec="DOM4" title=concept-node-append class="externalDFN">append</a> nodes
                    to <var>root</var>, for example to describe the nature of the
                    error.

                    <li><a data-spec="DOM4" title="concept-node-append" class="externalDFN">Append</a>
                    <var>root</var> to <var>document</var>.

                    <li>Return <var>document</var>.
                </ol>
            </dl>

            <p>In any case, the returned
            <a title=concept-document data-spec="DOM4" class="externalDFN">document</a>'s
            <a title=concept-document-content-type data-spec="DOM4" class="externalDFN">content type</a>
            must be the <var>type</var> argument.

            <div class="issue">
                <p>It is currently unclear what the
                <a title=concept-document-url data-spec="DOM4" class="externalDFN">URL</a> of the returned
                <a title=concept-document data-spec="DOM4" class="externalDFN">document</a> should be.

                <p>Results for a <a href="http://software.hixie.ch/utilities/js/live-dom-viewer/saved/1322">test case</a>:
                <table>
                <thead>
                    <tr>
                    <th><th>Gecko<th>Opera<th>Chrome
                <tbody>
                    <tr>
                    <th>document.location <td colspan=3>null
                    <tr>
                    <th>document.URL <td>unsupported <td>unsupported <td>""
                    <tr>
                    <th>document.documentURI <td>Page URL <td>null <td>null
                </table>

                <p>Anne van Kesteren suggests using the default, about:blank.
            </div>

            <p class=note>The returned
            <a title=concept-document data-spec="DOM4" class="externalDFN">document</a>'s
            <a title=concept-document-encoding data-spec="DOM4" class="externalDFN">encoding</a> is
            the default, UTF-8.
        </dd>
    </dl>
</section>

<section>
    <h1>The <code>XMLSerializer</code> interface</h1>

    <p>The <dfn title=dom-XMLSerializer><code>XMLSerializer()</code></dfn>
    constructor must return a new <code>XMLSerializer</code> object.

    <dl class="idl" title="[Constructor] interface XMLSerializer">
        <dt>DOMString serializeToString(Node root)</dt>

        <dd>The <code>serializeToString(<var>root</var>)</code></dfn>
        method must <a title=concept-serialize-xml>produce an XML serialization</a> of <var>root</var> and return the result.</dd>
    </dl>
</section>

<section>
    <h1>Extensions to the <code><a title="element" data-spec="DOM4" class="externalDFN">Element</a></code> interface</h1>

    <dl class="idl" title="partial interface Element">
        <dt>[TreatNullAs=EmptyString] attribute DOMString innerHTML</dt>
        <dd>
            <p>The <dfn title=dom-Element-innerHTML><code>innerHTML</code></dfn> IDL
            attribute represents the markup of the
            <code><a title="element" data-spec="DOM4" class="externalDFN">Element</a></code>'s contents.

            <dl class=domintro>
                <!--doc.ih
                <dt><var>document</var> . <code title=dom-Document-innerHTML>innerHTML</code> [ = <var>value</var> ]
                <dd>
                <p>Returns a fragment of HTML or XML that represents the
                <code><a title="document" data-spec="DOM4" class="externalDFN">Document</a></code>.

                <p>Can be set, to replace the
                <code><a title="document" data-spec="DOM4" class="externalDFN">Document</a></code>'s contents with the result of
                parsing the given string.

                <p>In the case of an <a title="xml-document" data-spec="DOM4" class="externalDFN">XML document</a>,
                will throw an
                <code><a data-spec="DOM4" title=domexception class="externalDFN">DOMException</a></code> with name <code>InvalidStateError</code>
                if the <code><a title="document" data-spec="DOM4" class="externalDFN">Document</a></code> cannot be serialized
                to XML, and a
                <code><a data-spec="DOM4" title=domexception class="externalDFN">DOMException</a></code> with name <code>SyntaxError</code>
                if the given string is not well-formed.
                -->

                <dt><var>element</var> . <code title=dom-Element-innerHTML>innerHTML</code> [ = <var>value</var> ]
                <dd>
                <p>Returns a fragment of HTML or XML that represents the element's
                contents.

                <p>Can be set, to replace the contents of the element with nodes
                parsed from the given string.

                <p>In the case of an <a title="xml-document" data-spec="DOM4" class="externalDFN">XML document</a>,
                will throw a
                <code><a data-spec="DOM4" title=domexception class="externalDFN">DOMException</a></code> with name <code>InvalidStateError</code>
                if the <code><a title="element" data-spec="DOM4" class="externalDFN">Element</a></code> cannot be serialized
                to XML, and a
                <code><a data-spec="DOM4" title=domexception class="externalDFN">DOMException</a></code> with name <code>SyntaxError</code>
                if the given string is not well-formed.
            </dl>

            <p>On getting, if the <a title="context object">context object</a>'s
            <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
            is an <a title="html-document" data-spec="DOM4" class="externalDFN">HTML document</a>, then the attribute
            must return the result of running the
            <a data-spec="HTML5" title="html-fragment-serialization-algorithm" class="externalDFN">HTML fragment serialization algorithm</a> on the
            <a title="context object">context object</a>; otherwise, the <a title="context object">context object</a>'s
            <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
            is an <a title="xml-document" data-spec="DOM4" class="externalDFN">XML document</a>, and the attribute must
            return the result of running the        
            <a data-spec="HTML5" title="xml-fragment-serialization-algorithm" class="externalDFN">XML fragment serialization algorithm</a> on the
            <a title="context object">context object</a> instead (this might throw an
            exception instead of returning a string).

            <p>On setting, these steps must be run:

            <ol>
                <li>Let <var>fragment</var> be the result of invoking the
                <a title="concept-parse-fragment">fragment parsing algorithm</a> with
                the new value as <var>markup</var>, and the
                <a title="context object">context object</a> as the <var>context element</var>.

                <li><a data-spec="DOM4" title=concept-node-replace-all class="externalDFN">Replace all</a>
                with <var>fragment</var> within the <a title="context object">context object</a>.
            </ol>
        </dd>

        <!-- outerHTML -->
        <dt>[TreatNullAs=EmptyString] attribute DOMString outerHTML</dt>
        <dd>
            <p>The <dfn title=dom-Element-outerHTML><code>outerHTML</code></dfn> IDL
            attribute represents the markup of the
            <code><a title="element" data-spec="DOM4" class="externalDFN">Element</a></code> and its contents.

            <dl class=domintro>
              <dt><var>element</var> . <code title=dom-Element-outerHTML>outerHTML</code> [ = <var>value</var> ]
              <dd>
                <p>Returns a fragment of HTML or XML that represents the element and its
                contents.

                <p>Can be set, to replace the element with nodes parsed from the given
                string.

                <p>In the case of an <a title="xml-document" data-spec="DOM4" class="externalDFN">XML document</a>,
                will throw a
                <code><a data-spec="DOM4" title=domexception class="externalDFN">DOMException</a></code> with name <code>InvalidStateError</code>
                if the element cannot be serialized to XML, and a
                <code><a data-spec="DOM4" title=domexception class="externalDFN">DOMException</a></code> with name <code>SyntaxError</code>
                if the given string is not well-formed.

                <p>Throws a
                <code><a data-spec="DOM4" title=domexception class="externalDFN">DOMException</a></code> with name <code>NoModificationAllowedError</code>
                if the parent of the element is the
                <code><a title="document" data-spec="DOM4" class="externalDFN">Document</a></code> node.
            </dl>

            <p>On getting, if the <a title="context object">context object</a>'s
            <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
            is an <a title="html-document" data-spec="DOM4" class="externalDFN">HTML document</a>, then the attribute
            must return the result of running the
            <a data-spec="HTML5" title="html-fragment-serialization-algorithm" class="externalDFN">HTML fragment serialization algorithm</a> on a
            fictional node whose only child is <a title="context object">context object</a>; otherwise, the
            <a title="context object">context object</a>'s
            <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
            is an <a title="xml-document" data-spec="DOM4" class="externalDFN">XML document</a>, and the attribute must
            return the result of running the
            <a data-spec="HTML5" title="xml-fragment-serialization-algorithm" class="externalDFN">XML fragment serialization algorithm</a> on that
            fictional node instead (this might throw an exception instead of returning a
            string).

            <p>On setting, the following steps must be run:

            <ol>
                <li>Let <var>parent</var> be the <a title="context object">context object</a>'s
                <a data-spec="DOM4" title=concept-tree-parent class="externalDFN">parent</a>.

                <li>If <var>parent</var> is null, terminate these steps. There would be no
                way to obtain a reference to the nodes created even if the remaining steps
                were run.

                <li>If <var>parent</var> is a
                <code><a title="document" data-spec="DOM4" class="externalDFN">Document</a></code>, throw a
                <code><a data-spec="DOM4" title=domexception class="externalDFN">DOMException</a></code> with name <code>NoModificationAllowedError</code>
                exception and terminate these steps.

                <li>If <var>parent</var> is a
                <code><a title="documentfragment" data-spec="DOM4" class="externalDFN">DocumentFragment</a></code>, let
                <var>parent</var> be a new
                <code><a title="element" data-spec="DOM4" class="externalDFN">Element</a></code> with

                <ul>
                    <li><code>body</code> as its
                    <a data-spec="DOM4" title=concept-element-local-name class="externalDFN">local name</a>,

                    <li>the <a data-spec="DOM4" title="html-namespace" class="externalDFN">HTML namespace</a> as its
                    <a data-spec="DOM4" title="concept-element-namespace" class="externalDFN">namespace</a>, and
                    <li>the <a title="context object">context object</a>'s
                    <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
                    as its
                    <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>.
                </ul>

                <li>Let <var>fragment</var> be the result of invoking the
                <a title="concept-parse-fragment">fragment parsing algorithm</a> with
                the new value as <var>markup</var>, and <var>parent</var> as
                the <var>context element</var>.

                <li><a data-spec="DOM4" title=concept-node-replace class="externalDFN">Replace</a>
                the <a title="context object">context object</a> with <var>fragment</var> within
                the <a title="context object">context object</a>'s
                <a data-spec="DOM4" title=concept-tree-parent class="externalDFN">parent</a>.
            </ol>
        </dd>

        <!-- insertAdjacentHTML -->
        <dt>void insertAdjacentHTML(DOMString position, DOMString text)</dt>
        <dd>
             <dl class=domintro>
                  <dt><var>element</var> . <code title=dom-Element-insertAdjacentHTML>insertAdjacentHTML</code>(<var>position</var>, <var>text</var>)

                  <dd>
                    <p>Parses the given string <var>text</var> as HTML or XML and inserts
                    the resulting nodes into the tree in the position given by the
                    <var>position</var> argument, as follows:

                    <dl>
                      <dt>"beforebegin"
                      <dd>Before the element itself.

                      <dt>"afterbegin"
                      <dd>Just inside the element, before its first child.

                      <dt>"beforeend"
                      <dd>Just inside the element, after its last child.

                      <dt>"afterend"
                      <dd>After the element itself.
                    </dl>

                    <p>Throws a <code>SyntaxError</code> exception if the arguments have invalid values (e.g., in the case of an
                    <a data-spec="DOM4" title="XML-document" class="externalDFN">XML document</a>, if the given string is
                    not well-formed).

                    <p>Throws a
                    <code><a data-spec="DOM4" title=domexception class="externalDFN">DOMException</a></code> with name <code>NoModificationAllowedError</code>
                    if the given position isn't possible (e.g. inserting elements
                    after the root element of a <code><a title="document" data-spec="DOM4" class="externalDFN">Document</a></code>).
                </dl>

                <p>The
                <dfn title=dom-Element-insertAdjacentHTML><code>insertAdjacentHTML(<var>position</var>, <var>text</var>)</code></dfn>
                method must run these steps:

                <ol>
                    <li>Use the first matching item from this list:

                    <dl class=switch>
                        <dt>If <var>position</var> is an
                        <a data-spec="DOM4" class="externalDFN" title="ascii-case-insensitive">ASCII case-insensitive</a> match for
                        the string "beforebegin"

                        <dt>If <var>position</var> is an
                        <a data-spec="DOM4" class="externalDFN" title="ascii-case-insensitive">ASCII case-insensitive</a> match for
                        the string "afterend"

                        <dd>
                            <p>Let <var>context</var> be the <a title="context object">context object</a>'s
                            <a data-spec="DOM4" title=concept-tree-parent class="externalDFN">parent</a>.

                            <p>If <var>context</var> is null or a
                            <a data-spec="DOM4" class="externalDFN" title="concept-document">document</a>, throw
                            a
                            <code><a data-spec="DOM4" title=domexception class="externalDFN">DOMException</a></code> with name <code>NoModificationAllowedError</code>
                            and terminate these steps.

                        <dt>If <var>position</var> is an
                        <a data-spec="DOM4" class="externalDFN" title="ascii-case-insensitive">ASCII case-insensitive</a> match for
                        the string "afterbegin"

                        <dt>If <var>position</var> is an
                        <a data-spec="DOM4" class="externalDFN" title="ascii-case-insensitive">ASCII case-insensitive</a> match for
                        the string "beforeend"

                        <dd>Let <var>context</var> be the <a title="context object">context object</a>.

                        <dt>Otherwise
                        <dd>
                            <p>Throw a <code>SyntaxError</code> exception.
                    </dl>

                  <li>If <var>context</var> is not an
                    <code><a title="element" data-spec="DOM4" class="externalDFN">Element</a></code> or the following are all true:

                    <ul>
                      <li><var>context</var>'s
                      <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
                      is an <a title="html-document" data-spec="DOM4" class="externalDFN">HTML document</a>,

                      <li><var>context</var>'s
                      <a data-spec="DOM4" title=concept-element-local-name class="externalDFN">local name</a>
                      is "<code>html</code>", and

                      <li><var>context</var>'s
                      <a data-spec="DOM4" title="concept-element-namespace" class="externalDFN">namespace</a>
                      is the <a data-spec="DOM4" title="html-namespace" class="externalDFN">HTML namespace</a>;
                    </ul>

                    <p>let <var>context</var> be a new
                    <code><a title="element" data-spec="DOM4" class="externalDFN">Element</a></code> with

                    <ul>
                      <li><code>body</code> as its
                      <a data-spec="DOM4" title=concept-element-local-name class="externalDFN">local name</a>,

                      <li>the <a data-spec="DOM4" title="html-namespace" class="externalDFN">HTML namespace</a> as its
                      <a data-spec="DOM4" title="concept-element-namespace" class="externalDFN">namespace</a>, and

                      <li>the <a title="context object">context object</a>'s
                      <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
                      as its
                      <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>.
                    </ul>

                <li>Let <var>fragment</var> be the result of invoking the
                <a title="concept-parse-fragment">fragment parsing algorithm</a> with <var>text</var> as 
                <var>markup</var>, and <var>parent</var> as the <var>context element</var>.

                <li>Use the first matching item from this list:

                <dl class=switch>
                    <dt>If <var>position</var> is an
                    <a data-spec="DOM4" class="externalDFN" title="ascii-case-insensitive">ASCII case-insensitive</a> match for
                    the string "beforebegin"
            
                    <dd><a data-spec="DOM4" title=concept-node-insert class="externalDFN">Insert</a>
                    <var>fragment</var> into the <a title="context object">context object</a>'s
                    <a data-spec="DOM4" title=concept-tree-parent class="externalDFN">parent</a>
                    before the <a title="context object">context object</a>.

                    <dt>If <var>position</var> is an
                    <a data-spec="DOM4" class="externalDFN" title="ascii-case-insensitive">ASCII case-insensitive</a> match for
                    the string "afterbegin"

                    <dd><a data-spec="DOM4" title=concept-node-insert class="externalDFN">Insert</a>
                    <var>fragment</var> into the <a title="context object">context object</a>
                    before its
                    <a data-spec="DOM4" title=concept-tree-first-child class="externalDFN">first child</a>.

                    <dt>If <var>position</var> is an
                    <a data-spec="DOM4" class="externalDFN" title="ascii-case-insensitive">ASCII case-insensitive</a> match for
                    the string "beforeend"

                    <dd><a data-spec="DOM4" title="concept-node-append" class="externalDFN">Append</a>
                    <var>fragment</var> to the <a title="context object">context object</a>.

                    <dt>If <var>position</var> is an
                    <a data-spec="DOM4" class="externalDFN" title="ascii-case-insensitive">ASCII case-insensitive</a> match for
                    the string "afterend"

                    <dd><a data-spec="DOM4" title=concept-node-insert class="externalDFN">Insert</a>
                    <var>fragment</var> into the <a title="context object">context object</a>'s
                    <a data-spec="DOM4" title=concept-tree-parent class="externalDFN">parent</a>
                    before the <a title="context object">context object</a>'s
                    <a data-spec="DOM4" title=concept-tree-next-sibling class="externalDFN">next sibling</a>.
                </dl>
            </ol>
        </dd>

    </dl>
</section>

<!-- Dropping this extention as it is not implemented, nor does it appear that any browser
     is currently interested in supporting it. Perhaps it can come back in a V2 of this spec
     if browsers become interested.
<section>
    <h1>Extensions to the <code><a title="text" data-spec="DOM4" class="externalDFN">Text</a></code> interface</h1>

    <dl class="idl" title="partial interface Text">
        <dt>attribute boolean serializeAsCDATA</dt>
        <dd>
            <dl class=domintro>
              <dt><var>text</var> .
                  <code title=dom-Text-serializeAsCDATA>serializeAsCDATA</code> [ = <var>value</var> ]
              <dd>Controls whether, in XML, this node is serialized as a CDATA section.
            </dl>

            <p><code><a title="text" data-spec="DOM4" class="externalDFN">Text</a></code> nodes have an additional
            associated flag, the <dfn>serialize as CDATA flag</dfn>.

            <p>The
            <dfn title=dom-Text-serializeAsCDATA><code>serializeAsCDATA</code></dfn>
            attribute must return true if the <a title="context object">context object</a> has its
            <a>serialize as CDATA flag</a> set, or false otherwise.

            <p>Setting the <code title=dom-Text-serializeAsCDATA>serializeAsCDATA</code>
            attribute must, if the new value is true, set the
            <a title="context object">context object</a>'s <a>serialize as CDATA flag</a>, or unset
            it otherwise.
        </dd>
    </dl>
</section>
-->

<section>
    <h1>Extensions to the <code><a data-spec="DOM4" title="range" class="externalDFN">Range</a></code> interface</h1>

    <dl class="idl" title="partial interface Range">
        <dt>DocumentFragment createContextualFragment(DOMString fragment)</dt>
        <dd>
            <dl class=domintro>
              <dt><var>fragment</var> = <var>range</var> . <code title=dom-Range-createContextualFragment>createContextualFragment</code>(<var>fragment</var>)
              <dd>Returns a <code><a title="documentfragment" data-spec="DOM4" class="externalDFN">DocumentFragment</a></code>, created
                from the markup string given.
            </dl>

            <p>The
            <dfn title=dom-Range-createContextualFragment><code>createContextualFragment(<var>fragment</var>)</code></dfn>
            method must run these steps:

            <ol>
                <li>Let <var>node</var> the <a title="context object">context object</a>'s
                <a data-spec="DOM4" title=concept-range-start-node class="externalDFN">start node</a>.

                <p>Let <var>element</var> be as follows, depending on <var>node</var>'s interface:

                <dl class=switch>
                    <dt><code><a title="document" data-spec="DOM4" class="externalDFN">Document</a></code>
                    <dt><code><a title="documentfragment" data-spec="DOM4" class="externalDFN">DocumentFragment</a></code>
                    <dd>null

                    <dt><code><a title="element" data-spec="DOM4" class="externalDFN">Element</a></code>
                    <dd><var>node</var>

                    <dt><code><a title="text" data-spec="DOM4" class="externalDFN">Text</a></code>
                    <dt><code><a title="comment" data-spec="DOM4" class="externalDFN">Comment</a></code>
                    <dd><var>node</var>'s
                    <a data-spec="DOM4" class="externalDFN" title="parent-element">parent element</a>

                    <dt><code><a title="documenttype" data-spec="DOM4" class="externalDFN">DocumentType</a></code>
                    <dt><code><a title="processinginstruction" data-spec="DOM4" class="externalDFN">ProcessingInstruction</a></code>
                    <dd>[[DOM4]] prevents this case.
                </dl>

                <li>If either <var>element</var> is null or the following are all true:

                    <ul>
                      <li><var>element</var>'s
                      <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
                      is an <a title="html-document" data-spec="DOM4" class="externalDFN">HTML document</a>,

                      <li><var>element</var>'s
                      <a data-spec="DOM4" title=concept-element-local-name class="externalDFN">local name</a>
                      is "<code>html</code>", and

                      <li><var>element</var>'s
                      <a data-spec="DOM4" title="concept-element-namespace" class="externalDFN">namespace</a>
                      is the <a data-spec="DOM4" title="html-namespace" class="externalDFN">HTML namespace</a>;
                    </ul>

                    <p>let <var>element</var> be a new
                    <a data-spec="DOM4" title=concept-element class="externalDFN">element</a> with

                    <ul>
                      <li>"<code>body</code>" as its
                      <a data-spec="DOM4" title=concept-element-local-name class="externalDFN">local name</a>,

                      <li>the <a data-spec="DOM4" title="html-namespace" class="externalDFN">HTML namespace</a> as its
                      <a data-spec="DOM4" title="concept-element-namespace" class="externalDFN">namespace</a>, and

                      <li>the <a title="context object">context object</a>'s
                      <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>
                      as its
                      <a title="concept-node-document" data-spec="DOM4" class="externalDFN">node document</a>.
                    </ul>

                <li>Let <var>fragment node</var> be the result of invoking the
                <a title="concept-parse-fragment">fragment parsing algorithm</a> with <var>fragment</var> as 
                <var>markup</var>, and <var>element</var> as the <var>context element</var>.

                <li>Unmark all scripts in <var>fragment node</var> as "already started".

                <li>Return <var>fragment node</var>.
            </ol>
        </dd>
    </dl>
</section>

<section class="appendix">
    <h1>Acknowledgements</h1>
    <p>Thanks to Ms2ger for maintaining the initial drafts of this specification and for its continued improvement.

    <p>Thanks to Anne van Kesteren, Aryeh Gregor, Boris Zbarsky, Henri Sivonen, Simon Pieters and timeless
    for their useful comments.

    <p>Special thanks to Ian Hickson for defining the
    <code title=dom-Element-innerHTML>innerHTML</code> and
    <code title=dom-Element-outerHTML>outerHTML</code> attributes, and the
    <code title=dom-Element-insertAdjacentHTML>insertAdjacentHTML()</code> method in
    [[HTML5]] and his useful comments.
</section>

</body>
</html>